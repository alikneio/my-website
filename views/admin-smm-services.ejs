<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin – SMM Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="/css/bootstrap.css" />
  <link rel="stylesheet" href="/css/custom.css" />
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
    rel="stylesheet"
  />
</head>
<body>
  <!-- Sidebar -->
  <%- include('partials/admin-sidebar', { user: user }) %>

  <main class="main-content">
    <div class="container-fluid py-4" style="max-width: 1300px;">

      <!-- Header -->
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h4 mb-0">
          <i class="bi bi-instagram"></i>
          SMM Services
        </h1>

        <a href="/admin/smm-services/sync" class="btn btn-primary btn-sm">
          <i class="bi bi-arrow-repeat"></i>
          Sync from Provider
        </a>
      </div>

      <!-- Filters -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form class="row g-3 align-items-end" method="get" action="/admin/smm-services">
            <div class="col-md-5">
              <label class="form-label text-uppercase small text-muted">Search</label>
              <input
                type="text"
                name="search"
                class="form-control"
                placeholder="Name, provider category or provider ID"
                value="<%= filters.search || '' %>"
              />
              <div class="form-text">
                Showing up to 200 latest services. Use filters لتخفيف العدد.
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label text-uppercase small text-muted">Category</label>
              <select name="category_id" class="form-select">
                <option value="all" <%= filters.category_id === 'all' ? 'selected' : '' %>>
                  All
                </option>
                <% categories.forEach(function(c){ %>
                  <option
                    value="<%= c.id %>"
                    <%= String(filters.category_id) === String(c.id) ? 'selected' : '' %>>
                    <%= c.name %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-2">
              <label class="form-label text-uppercase small text-muted">Status</label>
              <select name="status" class="form-select">
                <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All</option>
                <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
                <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
              </select>
            </div>

            <div class="col-md-2 d-flex gap-2">
              <button type="submit" class="btn btn-primary flex-grow-1">
                <i class="bi bi-funnel"></i> Apply
              </button>
              <a href="/admin/smm-services" class="btn btn-outline-secondary">
                Reset
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Services table -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h6 text-uppercase text-muted mb-0">Services list</h2>
            <small class="text-muted">
              <%= services && services.length ? services.length : 0 %> services found.
            </small>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 90px;">ID</th>
                  <th>Name</th>
                  <th style="width: 260px;">Category</th>
                  <th style="width: 120px;">Rate / 1000</th>
                  <th style="width: 140px;">Min / Max</th>
                  <th style="width: 120px;">Status</th>
                  <th style="width: 220px;" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (!services || !services.length) { %>
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      No services to display. جرّب تغيير الفلاتر أو فعل بعض الكاتيجوريز أولاً.
                    </td>
                  </tr>
                <% } else { %>
                  <% services.forEach(function(s) { %>
                    <tr>
                      <!-- ID + provider ID -->
                      <td>
                        <div class="fw-semibold text-muted">#<%= s.id %></div>
                        <div class="small text-muted">
                          Prov ID: <strong><%= s.provider_service_id %></strong>
                        </div>
                      </td>

                      <!-- Name + provider category badge -->
                      <td>
                        <div class="fw-semibold"><%= s.name %></div>

                        <% if (s.provider_category) { %>
                          <div class="mt-1">
                            <span class="badge bg-light text-muted border">
                              # <%= s.provider_category %>
                            </span>
                          </div>
                        <% } else { %>
                          <div class="small text-muted">No provider category</div>
                        <% } %>

                        <% if (s.category_name) { %>
                          <div class="small text-muted mt-1">
                            Store category:
                            <span class="fw-semibold"><%= s.category_name %></span>
                          </div>
                        <% } %>
                      </td>

                      <!-- Category select + quick save -->
                      <td>
                        <form
                          method="post"
                          action="/admin/smm-services/<%= s.id %>/update-category"
                          class="d-flex align-items-center gap-2"
                        >
                          <select
                            name="category_id"
                            class="form-select form-select-sm"
                          >
                            <option value="">— none —</option>
                            <% categories.forEach(function(c){ %>
                              <option
                                value="<%= c.id %>"
                                <%= String(s.category_id || '') === String(c.id) ? 'selected' : '' %>>
                                <%= c.name %>
                              </option>
                            <% }) %>
                          </select>

                          <button
                            type="submit"
                            class="btn btn-sm btn-outline-primary"
                          >
                            <i class="bi bi-save"></i>
                            Save
                          </button>
                        </form>
                      </td>

                      <!-- Rate -->
                      <td>
                        $<%= Number(s.rate).toFixed(4) %>
                      </td>

                      <!-- Min / Max -->
                      <td>
                        <div class="small">
                          <span class="text-muted">Min:</span>
                          <strong><%= s.min_qty %></strong>
                        </div>
                        <div class="small">
                          <span class="text-muted">Max:</span>
                          <strong><%= s.max_qty %></strong>
                        </div>
                      </td>

                      <!-- Status badge -->
                      <td>
                        <% if (s.is_active) { %>
                          <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Active
                          </span>
                        <% } else { %>
                          <span class="badge bg-secondary">
                            <i class="bi bi-pause-circle"></i> Disabled
                          </span>
                        <% } %>
                      </td>

                      <!-- Actions: toggle + edit -->
                      <td class="text-end">
                        <!-- Toggle status -->
                        <form
                          method="post"
                          action="/admin/smm-services/<%= s.id %>/toggle"
                          class="d-inline"
                        >
                          <button
                            type="submit"
                            class="btn btn-sm <%= s.is_active ? 'btn-warning' : 'btn-success' %>"
                          >
                            <i class="bi <%= s.is_active ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                            <%= s.is_active ? 'Disable' : 'Enable' %>
                          </button>
                        </form>

                        <!-- Full edit page -->
                        <a
                          href="/admin/smm-services/<%= s.id %>/edit"
                          class="btn btn-sm btn-outline-secondary ms-2"
                        >
                          <i class="bi bi-pencil-square"></i>
                          Edit
                        </a>
                      </td>
                    </tr>
                  <% }); %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/bootstrap.bundle.min.js"></script>
</body>
</html>
