<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= subCategoryName %> Products - AK Cell</title>

  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    .product-card{
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }

    .thumb-wrap{
      position: relative;
      background: #fff;
    }

    .thumb-wrap img{
      max-height: 150px;
      object-fit: contain;
    }

    /* Out of stock overlay + badge */
    .oos-overlay{
      position:absolute;
      inset:0;
      background: rgba(220,53,69,.18);
      backdrop-filter: blur(1px);
      z-index: 2;
    }

    .oos-badge{
      position:absolute;
      top: 12px;
      left: 12px;
      z-index: 3;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(220,53,69,.95);
      color: #fff;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .3px;
      box-shadow: 0 10px 18px rgba(220,53,69,.25);
      text-transform: uppercase;
    }

    .oos-badge i{ font-size: 14px; }

    /* Small improvements */
    .card-title{
      font-weight: 800;
      line-height: 1.25;
      min-height: 42px; /* يحافظ على تساوي ارتفاع الكروت */
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>

  <div class="container my-5">
    <h1 class="text-center mb-4"><%= subCategoryName %> Products</h1>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">

      <% if (products && products.length > 0) { %>
        <% products.forEach(product => { %>

          <%
            // ✅ OOS fix: يدعم 0/1 + "0"/"1" + true/false + أي رقم >0
            const rawOOS = (
              product.is_out_of_stock ??
              product.out_of_stock ??
              product.isOutOfStock ??
              product.outOfStock ??
              0
            );

            const oos = (Number(rawOOS) > 0) || String(rawOOS).toLowerCase() === 'true';

            const requiresPid = Number(product.requires_player_id ?? 0) === 1;
          %>

          <div class="col service-card">
            <div class="card h-100 text-center product-card">

              <div class="thumb-wrap">
                <% if (oos) { %>
                  <div class="oos-badge">
                    <i class="bi bi-x-octagon-fill"></i> OUT OF STOCK
                  </div>
                  <div class="oos-overlay"></div>
                <% } %>

                <img
                  src="<%= product.image %>"
                  class="card-img-top p-3"
                  alt="<%= product.name %>"
                  loading="lazy"
                >
              </div>

              <div class="card-body d-flex flex-column">
                <h5 class="card-title"><%= product.name %></h5>

                <p class="card-text fs-4 fw-bold mt-auto text-primary">
                  $<%= Number(product.price).toFixed(2) %>
                </p>

                <% if (user) { %>

                  <% if (oos) { %>
                    <button type="button" class="btn btn-outline-danger mt-2" disabled>
                      <i class="bi bi-x-circle me-1"></i> Out of Stock
                    </button>

                  <% } else if (requiresPid) { %>

                    <a href="/checkout/<%= product.id %>" class="btn btn-info mt-2">
                      <i class="bi bi-pencil-square me-1"></i> Enter Details
                    </a>

                  <% } else { %>

                    <form action="/process-checkout" method="POST" class="buy-form mt-2">
                      <input type="hidden" name="product_id" value="<%= product.id %>">
                      <input type="hidden" name="price" value="<%= product.price %>">
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-lightning-charge-fill me-1"></i> Buy Now
                      </button>
                    </form>

                  <% } %>

                <% } else { %>
                  <a href="/login" class="btn btn-secondary mt-2">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Login to Buy
                  </a>
                <% } %>

              </div>
            </div>
          </div>

        <% }) %>

      <% } else { %>
        <div class="col-12">
          <p class="text-muted fs-4 text-center">No products found in this category at the moment.</p>
        </div>
      <% } %>

    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.querySelectorAll('.buy-form').forEach(form => {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const button = this.querySelector('button');
        const originalText = button.innerHTML;

        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> جاري المعالجة...';

        try {
          const response = await fetch('/process-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              product_id: this.querySelector('[name="product_id"]').value
            })
          });

          const result = await response.json();

          if (result.success) {
            alert("تم الشراء بنجاح!\nالرصيد الجديد: $" + result.newBalance.toFixed(2));
            window.location.reload();
          } else {
            alert(
              result.message +
              "\nرصيدك الحالي: $" + (result.balance ? result.balance.toFixed(2) : 'غير معروف') +
              "\nالمطلوب: $" + (result.required ? result.required.toFixed(2) : 'غير معروف')
            );
          }
        } catch (error) {
          alert('فشل في الاتصال بالخادم');
        } finally {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      });
    });
  </script>
</body>
</html>
