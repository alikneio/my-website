<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage API Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body class="bg-light">
<div class="d-flex">
  <%- include('partials/admin-sidebar') %>

  <div class="container-fluid p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
      <div>
        <h1 class="mb-1">Manage API Products</h1>
        <p class="text-muted mb-0">Select which products from DailyCard you want to display on your site.</p>
      </div>

      <!-- ‚úÖ Sync Button -->
      <div class="d-flex gap-2">
        <button id="syncBtn" class="btn btn-success">
          <i class="bi bi-arrow-repeat"></i>
          <span class="btn-text">Sync from provider</span>
        </button>
      </div>
    </div>

    <!-- Alerts -->
    <div id="syncAlert" class="alert d-none" role="alert" aria-live="polite"></div>

    <!-- Search -->
    <form class="d-flex gap-2 mb-3" method="GET" action="/admin/api-products">
      <input
        type="search"
        name="q"
        class="form-control"
        placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨"
        value="<%= typeof q !== 'undefined' ? q : '' %>">
      <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> ÿ®ÿ≠ÿ´</button>
      <% if (q) { %>
        <a class="btn btn-outline-secondary" href="/admin/api-products"><i class="bi bi-x-circle"></i> ŸÖÿ≥ÿ≠</a>
      <% } %>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
        <tr>
          <th>Show on Site</th>
          <th>ID</th>
          <th>Name</th>
          <th>Price (Original / Custom)</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <% if (products && products.length > 0) { %>
          <% products.forEach(product => { 
               const isSelected = Number(product.is_selected) === 1; // ‚úÖ safe
          %>
            <tr>
              <td>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input product-toggle"
                    type="checkbox"
                    data-id="<%= product.id %>"
                    <%= isSelected ? 'checked' : '' %>>
                </div>
              </td>
              <td><%= product.id %></td>
              <td><%= product.name %></td>
              <td>
                <% if (product.product_type === 'quantity') { %>
                  <span class="text-warning">üî¢ Quantity-based</span>
                <% } else { %>
                  <span class="text-primary">üí≤ Fixed Price</span>
                <% } %>
                <br>
                Original: $<%= Number(product.price || 0).toFixed(2) %>
                <% if (product.custom_price) { %>
                  <br>
                  <strong class="text-success">Custom: $<%= Number(product.custom_price || 0).toFixed(2) %></strong>
                <% } %>
              </td>
              <td>
                <a href="/admin/api-products/edit/<%= product.id %>" class="btn btn-warning btn-sm">Edit</a>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="5" class="text-center py-4">
              <% if (q) { %>
                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸê "<strong><%= q %></strong>"
              <% } else { %>
                No products found from API.
              <% } %>
            </td>
          </tr>
        <% } %>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="mt-4 d-flex justify-content-center">
        <nav>
          <ul class="pagination">
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <a class="page-link"
                   href="/admin/api-products?page=<%= i %><%= q ? '&q=' + encodeURIComponent(q) : '' %>">
                  <%= i %>
                </a>
              </li>
            <% } %>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<script>
  // Toggle selected products
  document.querySelectorAll('.product-toggle').forEach(toggle => {
    toggle.addEventListener('change', async (e) => {
      const productId = e.target.dataset.id;
      const isActive = e.target.checked;

      try {
        const response = await fetch('/admin/api-products/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, isActive })
        });
        const result = await response.json();
        if (!result.success) {
          alert('Failed to update product status.');
          e.target.checked = !isActive;
        }
      } catch (error) {
        alert('Connection error.');
        e.target.checked = !isActive;
      }
    });
  });

  // ‚úÖ Sync from provider
  const syncBtn = document.getElementById('syncBtn');
  const syncAlert = document.getElementById('syncAlert');

  function showAlert(type, msg) {
    syncAlert.className = 'alert alert-' + type;
    syncAlert.textContent = msg;
    syncAlert.classList.remove('d-none');
  }

  if (syncBtn) {
    syncBtn.addEventListener('click', async () => {
      const icon = syncBtn.querySelector('i');
      const text = syncBtn.querySelector('.btn-text');

      syncBtn.disabled = true;
      if (icon) icon.classList.add('bi-arrow-repeat'); // already
      if (icon) icon.classList.add('spinner-border', 'spinner-border-sm');
      if (icon) icon.classList.remove('bi', 'bi-arrow-repeat');
      if (text) text.textContent = 'Syncing...';

      try {
        const res = await fetch('/admin/api-products/sync', { method: 'POST' });
        const data = await res.json();

        if (!data.success) {
          showAlert('danger', data.message || 'Sync failed.');
        } else {
          showAlert('success', data.message || 'Sync completed.');
          // refresh to show latest products
          setTimeout(() => window.location.reload(), 600);
        }
      } catch (err) {
        showAlert('danger', 'Connection error during sync.');
      } finally {
        // restore button
        syncBtn.disabled = false;
        if (icon) {
          icon.className = 'bi bi-arrow-repeat';
        }
        if (text) text.textContent = 'Sync from provider';
      }
    });
  }
</script>
</body>
</html>
