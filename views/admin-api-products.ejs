<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage API Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    .page-title { line-height: 1.1; }
    .sticky-actions {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(248, 249, 250, .92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table thead th { white-space: nowrap; }
    .cell-compact { white-space: nowrap; }
    .badge-soft {
      border: 1px solid rgba(0,0,0,.1);
      background: rgba(255,255,255,.6);
    }
    .row-disabled { opacity: .65; }
    .truncate {
      max-width: 420px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: bottom;
    }
    @media (max-width: 768px) { .truncate { max-width: 220px; } }

    /* small helper for action buttons */
    .btn-icon { display: inline-flex; align-items: center; gap: .35rem; }
  </style>
</head>

<body class="bg-light">
<div class="d-flex">
  <%- include('partials/admin-sidebar') %>

  <div class="container-fluid p-4">

    <!-- Header + actions (sticky) -->
    <div class="sticky-actions py-3 mb-3">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <h1 class="page-title mb-1">Manage API Products</h1>
          <div class="text-muted small">Select which products from DailyCard you want to display on your site.</div>
        </div>

        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button id="syncBtn" class="btn btn-success">
            <i class="bi bi-arrow-repeat me-1"></i>
            <span class="btn-text">Sync from provider</span>
          </button>
        </div>
      </div>

      <!-- Alerts -->
      <div id="syncAlert" class="alert d-none mt-3 mb-0" role="alert" aria-live="polite"></div>
    </div>

    <!-- Search -->
    <form class="d-flex gap-2 mb-3" method="GET" action="/admin/api-products" role="search" aria-label="Search API products">
      <input
        type="search"
        name="q"
        class="form-control"
        placeholder="ابحث بالاسم أو رقم المنتج"
        value="<%= typeof q !== 'undefined' ? q : '' %>"
        autocomplete="off">
      <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> بحث</button>
      <% if (q) { %>
        <a class="btn btn-outline-secondary" href="/admin/api-products"><i class="bi bi-x-circle"></i> مسح</a>
      <% } %>
    </form>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th class="cell-compact">Show on Site</th>
            <th class="cell-compact">ID</th>
            <th>Name</th>
            <th>Type / Price</th>
            <th class="cell-compact">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% if (products && products.length > 0) { %>

            <% products.forEach(product => {
              const isSelected = Number(product.is_selected) === 1;
              const isQty = String(product.product_type || '').toLowerCase() === 'quantity';

              const id = product.id;
              const name = product.name || ('Product ' + id);

              const original = Number(product.price || 0);
              const customRaw = (product.custom_price !== null && product.custom_price !== undefined && product.custom_price !== '')
                ? Number(product.custom_price)
                : null;
              const hasCustom = (customRaw !== null && Number.isFinite(customRaw));

              const searchKey = (String(id) + ' ' + String(name)).toLowerCase();
            %>

              <tr data-id="<%= id %>" data-search="<%= searchKey %>" class="<%= isSelected ? '' : 'row-disabled' %>">
                <td class="cell-compact">
                  <div class="form-check form-switch m-0">
                    <input
                      class="form-check-input product-toggle"
                      type="checkbox"
                      data-id="<%= id %>"
                      <%= isSelected ? 'checked' : '' %>
                      aria-label="Toggle product <%= id %>">
                  </div>
                </td>

                <td class="cell-compact mono"><%= id %></td>

                <td>
                  <span class="truncate" title="<%= name %>"><%= name %></span>
                </td>

                <td>
                  <% if (isQty) { %>
                    <span class="badge text-warning-emphasis badge-soft">
                      <i class="bi bi-123 me-1"></i> Quantity-based
                    </span>
                  <% } else { %>
                    <span class="badge text-primary-emphasis badge-soft">
                      <i class="bi bi-cash-coin me-1"></i> Fixed price
                    </span>
                  <% } %>

                  <div class="mt-1 small">
                    <span class="text-muted">Original:</span>
                    <span class="fw-semibold">$<%= Number.isFinite(original) ? original.toFixed(2) : '0.00' %></span>

                    <% if (hasCustom) { %>
                      <span class="mx-2 text-muted">|</span>
                      <span class="text-muted">Custom:</span>
                      <span class="fw-bold text-success">$<%= customRaw.toFixed(2) %></span>
                    <% } %>
                  </div>
                </td>

                <td class="cell-compact">
                  <div class="d-flex flex-wrap gap-2">
                    <a href="/admin/api-products/edit/<%= id %>" class="btn btn-warning btn-sm btn-icon">
                      <i class="bi bi-pencil-square"></i> Edit
                    </a>

                    <!-- ✅ Reset Local Button -->
                    <button
                      type="button"
                      class="btn btn-outline-danger btn-sm btn-icon reset-btn"
                      data-id="<%= id %>"
                      data-name="<%= name.replace(/"/g, '&quot;') %>">
                      <i class="bi bi-trash3"></i> Reset
                    </button>
                  </div>
                </td>
              </tr>

            <% }) %>

          <% } else { %>
            <tr>
              <td colspan="5" class="text-center py-4">
                <% if (q) { %>
                  لا توجد نتائج لِ "<strong><%= q %></strong>"
                <% } else { %>
                  No products found from API.
                <% } %>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="mt-4 d-flex justify-content-center">
        <nav aria-label="Pagination">
          <ul class="pagination flex-wrap">
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <a
                  class="page-link"
                  href="/admin/api-products?page=<%= i %><%= q ? '&q=' + encodeURIComponent(q) : '' %>"
                  aria-label="Page <%= i %>">
                  <%= i %>
                </a>
              </li>
            <% } %>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- Helpers ----------
  const syncAlert = document.getElementById('syncAlert');
  function showAlert(type, msg) {
    if (!syncAlert) return;
    syncAlert.className = 'alert alert-' + type + ' mt-3 mb-0';
    syncAlert.textContent = msg;
    syncAlert.classList.remove('d-none');
  }

  async function safeFetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();

    let data = null;
    try { data = JSON.parse(text); } catch (_) {}

    const isHtml = /<html|<!doctype/i.test(text);
    return { res, text, data, isHtml };
  }

  // ---------- Toggle selected products ----------
  document.querySelectorAll('.product-toggle').forEach(toggle => {
    toggle.addEventListener('change', async (e) => {
      const el = e.target;
      const productId = el.dataset.id;
      const isActive = el.checked;
      el.disabled = true;

      try {
        const { res, data, text, isHtml } = await safeFetchJson('/admin/api-products/toggle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ productId, isActive })
        });

        if (!res.ok || !data || data.success !== true) {
          el.checked = !isActive;
          const reason = data?.message || data?.error || (isHtml ? 'HTML/redirect response' : (text || '').slice(0, 120)) || 'Toggle failed';
          showAlert('danger', `Toggle failed for ID ${productId}: ${reason}`);
          return;
        }

        const row = el.closest('tr');
        if (row) {
          if (el.checked) row.classList.remove('row-disabled');
          else row.classList.add('row-disabled');
        }

      } catch (err) {
        el.checked = !isActive;
        showAlert('danger', `Network error while toggling ID ${productId}.`);
      } finally {
        el.disabled = false;
      }
    });
  });

  // ---------- Sync from provider ----------
  const syncBtn = document.getElementById('syncBtn');

  async function runSync(force = false) {
    const { res, data, text: rawText, isHtml } = await safeFetchJson('/admin/api-products/sync' + (force ? '?force=1' : ''), {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    if (!res.ok) {
      const reason = data?.message || (isHtml ? 'HTML/redirect response' : rawText.slice(0, 160));
      throw new Error(`Sync failed (HTTP ${res.status}): ${reason}`);
    }
    if (!data) throw new Error(`Sync failed: server did not return JSON.`);
    if (!data.success) throw new Error(data.message || 'Sync failed.');

    return data;
  }

  if (syncBtn) {
    syncBtn.addEventListener('click', async () => {
      const icon = syncBtn.querySelector('i');
      const text = syncBtn.querySelector('.btn-text');

      syncBtn.disabled = true;
      if (text) text.textContent = 'Syncing...';
      if (icon) icon.className = 'spinner-border spinner-border-sm me-2';

      try {
        const data = await runSync(false);
        showAlert('success', data.message || 'Sync completed.');
        setTimeout(() => window.location.reload(), 700);
      } catch (err) {
        showAlert('danger', err.message || 'Network error during sync.');
      } finally {
        syncBtn.disabled = false;
        if (icon) icon.className = 'bi bi-arrow-repeat me-1';
        if (text) text.textContent = 'Sync from provider';
      }
    });
  }

  // ---------- Reset Local + Sync(force) ----------
  document.querySelectorAll('.reset-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const productId = btn.dataset.id;
      const name = btn.dataset.name || `ID ${productId}`;

      const ok = confirm(`Reset local settings for:\n${name}\n\nThis will disable it and remove custom overrides (price/image/name/category).`);
      if (!ok) return;

      btn.disabled = true;
      const oldHtml = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting...';

      try {
        // 1) reset local
        const { res, data, text, isHtml } = await safeFetchJson('/admin/api-products/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ productId })
        });

        if (!res.ok || !data || data.success !== true) {
          const reason = data?.message || data?.error || (isHtml ? 'HTML/redirect response' : (text || '').slice(0, 160)) || 'Reset failed';
          throw new Error(`Reset failed (HTTP ${res.status}): ${reason}`);
        }

        showAlert('success', data.message || `Local settings reset for ID ${productId}. Syncing...`);

        // 2) force sync so cached provider list refreshes
        const syncData = await runSync(true);
        showAlert('success', (syncData.message || 'Sync done') + ' — reloading...');
        setTimeout(() => window.location.reload(), 700);

      } catch (err) {
        showAlert('danger', err.message || 'Reset failed.');
        btn.disabled = false;
        btn.innerHTML = oldHtml;
        return;
      }
    });
  });
</script>
</body>
</html>
