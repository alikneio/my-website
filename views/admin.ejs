<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    :root{
      --card-radius: 16px;
    }
    body { background: #f6f7fb; }

    .page-wrap { min-height: 100vh; }

    .content-area{
      width: 100%;
      padding: 28px;
    }

    .page-header{
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.06);
      padding: 18px 18px;
      margin-bottom: 18px;
    }

    .stats-card{
      border-radius: var(--card-radius);
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
      transition: transform .15s ease, box-shadow .15s ease;
      overflow: hidden;
      background: #fff;
      height: 100%;
    }
    .stats-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 40px rgba(15,23,42,0.10);
    }
    .stats-icon{
      width: 44px; height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      font-size: 1.2rem;
      background: rgba(13,110,253,0.10);
      color: #0d6efd;
    }
    .stats-icon.success{ background: rgba(25,135,84,0.12); color: #198754; }
    .stats-icon.purple{ background: rgba(111,66,193,0.12); color: #6f42c1; }

    .muted { color: #6b7280; }

    .panel-card{
      border-radius: var(--card-radius);
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
      background: #fff;
      overflow: hidden;
    }

    .panel-card .card-header{
      background: #fff;
      border-bottom: 1px solid rgba(15,23,42,0.06);
      padding: 16px 18px;
    }

    .form-help{
      font-size: .85rem;
      color: #6b7280;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(15,23,42,0.03);
      font-size: .85rem;
    }

    .preview-box{
      border-radius: 14px;
      border: 1px dashed rgba(15,23,42,0.18);
      background: rgba(15,23,42,0.02);
      padding: 12px 14px;
    }

    @media (max-width: 576px){
      .content-area{ padding: 14px; }
    }
  </style>
</head>

<body class="bg-light">
  <div class="d-flex page-wrap">
    <%- include('partials/admin-sidebar') %>

    <div class="content-area">

      <!-- Header -->
      <div class="page-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-speedometer2 text-primary"></i>
              <span class="muted">Admin</span>
              <span class="muted">/</span>
              <span class="fw-semibold">Dashboard</span>
            </div>
            <h2 class="mb-0 fw-bold">Dashboard</h2>
            <div class="muted mt-1">Quick overview of users, orders, and revenue.</div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="pill">
              <i class="bi bi-clock"></i>
              <span id="nowText">—</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
          <div class="stats-card p-3">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="stats-icon purple"><i class="bi bi-people"></i></span>
                  <div class="muted">Total Users</div>
                </div>
                <div class="fs-2 fw-bold"><%= stats.userCount %></div>
                <div class="form-help">Registered accounts</div>
              </div>
              <i class="bi bi-person-check text-muted" style="font-size:1.2rem;"></i>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="stats-card p-3">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="stats-icon"><i class="bi bi-bag-check"></i></span>
                  <div class="muted">Total Orders</div>
                </div>
                <div class="fs-2 fw-bold"><%= stats.orderCount %></div>
                <div class="form-help">All orders created</div>
              </div>
              <i class="bi bi-receipt text-muted" style="font-size:1.2rem;"></i>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="stats-card p-3">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="stats-icon success"><i class="bi bi-cash-coin"></i></span>
                  <div class="muted">Total Revenue</div>
                </div>
                <div class="fs-2 fw-bold text-success">
                  $<%= parseFloat(stats.totalRevenue || 0).toFixed(2) %>
                </div>
                <div class="form-help">Sum of paid orders</div>
              </div>
              <i class="bi bi-graph-up-arrow text-muted" style="font-size:1.2rem;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Balance -->
      <div class="panel-card">
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-wallet2 me-2 text-primary"></i>
              Manage User Balances
            </h5>
            <div class="form-help mt-1">Add or deduct balance safely with a quick preview.</div>
          </div>
          <span id="opBadge" class="pill">
            <i class="bi bi-plus-circle"></i>
            <span>Operation: Add</span>
          </span>
        </div>

        <div class="card-body p-3 p-md-4">
          <form action="/admin/update-balance" method="POST" class="row g-3 align-items-end" onsubmit="return confirmSubmit()">
            <div class="col-12 col-md-5">
              <label for="userId" class="form-label fw-semibold">Select User</label>
              <select name="userId" id="userId" class="form-select" required onchange="updatePreview()">
                <% users.forEach(u => { %>
                  <option value="<%= u.id %>" data-balance="<%= parseFloat(u.balance || 0) %>">
                    <%= u.username %> — Balance: $<%= parseFloat(u.balance || 0).toFixed(2) %>
                  </option>
                <% }) %>
              </select>
              <div class="form-help mt-1">Choose the user you want to update.</div>
            </div>

            <div class="col-12 col-md-3">
              <label for="amount" class="form-label fw-semibold">Amount</label>
              <input
                type="number"
                name="amount"
                id="amount"
                class="form-control"
                placeholder="e.g., 50"
                step="0.01"
                min="0.01"
                required
                oninput="updatePreview()"
              >
              <div class="form-help mt-1">Minimum: $0.01</div>
            </div>

            <div class="col-12 col-md-2">
              <label for="operation" class="form-label fw-semibold">Operation</label>
              <select name="operation" id="operation" class="form-select" required onchange="updatePreview()">
                <option value="add">➕ Add</option>
                <option value="deduct">➖ Deduct</option>
              </select>
              <div class="form-help mt-1">Add or remove.</div>
            </div>

            <div class="col-12 col-md-2">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-check2-circle me-1"></i> Apply
              </button>
            </div>

            <!-- Preview -->
            <div class="col-12">
              <div class="preview-box d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-info-circle text-primary"></i>
                  <div class="muted">
                    Current: <strong id="curBal">$0.00</strong> →
                    After: <strong id="newBal">$0.00</strong>
                  </div>
                </div>
                <div class="muted">
                  Selected: <strong id="selUser">—</strong>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>

  <script>
    function money(n){
      const x = Number(n || 0);
      return "$" + (isFinite(x) ? x.toFixed(2) : "0.00");
    }

    function updatePreview(){
      const userSel = document.getElementById('userId');
      const opSel   = document.getElementById('operation');
      const amount  = Number(document.getElementById('amount').value || 0);

      const opt = userSel.options[userSel.selectedIndex];
      const usernameText = opt ? (opt.textContent || '').trim() : '—';
      const cur = Number(opt?.dataset?.balance || 0);

      const op = opSel.value;
      let after = cur;

      if(op === 'add') after = cur + amount;
      else after = cur - amount;

      // Update badge
      const badge = document.getElementById('opBadge');
      if(badge){
        if(op === 'add'){
          badge.innerHTML = '<i class="bi bi-plus-circle"></i><span>Operation: Add</span>';
          badge.style.borderColor = 'rgba(25,135,84,0.35)';
          badge.style.background = 'rgba(25,135,84,0.08)';
        }else{
          badge.innerHTML = '<i class="bi bi-dash-circle"></i><span>Operation: Deduct</span>';
          badge.style.borderColor = 'rgba(220,53,69,0.35)';
          badge.style.background = 'rgba(220,53,69,0.08)';
        }
      }

      document.getElementById('curBal').textContent = money(cur);
      document.getElementById('newBal').textContent = money(after);
      document.getElementById('selUser').textContent = usernameText;

      // if deduct and would go negative -> warn visually
      const newBalEl = document.getElementById('newBal');
      if(op === 'deduct' && after < 0){
        newBalEl.classList.add('text-danger');
      }else{
        newBalEl.classList.remove('text-danger');
      }
    }

    function confirmSubmit(){
      const op = document.getElementById('operation').value;
      const amount = Number(document.getElementById('amount').value || 0);
      const newBalText = document.getElementById('newBal').textContent;

      if(!amount || amount <= 0){
        alert("Please enter a valid amount.");
        return false;
      }

      if(op === 'deduct' && newBalText.includes('-')){
        return confirm("Warning: This will make the user balance negative. Continue?");
      }

      return true;
    }

    // clock
    function updateClock(){
      const el = document.getElementById('nowText');
      if(!el) return;
      const d = new Date();
      el.textContent = d.toLocaleString();
    }

    window.addEventListener('DOMContentLoaded', () => {
      updatePreview();
      updateClock();
      setInterval(updateClock, 1000);
    });
  </script>

</body>
</html>
