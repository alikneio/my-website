<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - <%= product.name %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .checkout-card {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
      margin: 0 auto;
    }
    @media (max-width: 576px) {
      .checkout-card {
        width: 100% !important;
        padding-left: 12px;
        padding-right: 12px;
      }
    }
  </style>
</head>
<body>

<%- include('partials/header') %>

<div class="container py-5">
  <div class="checkout-card mx-auto px-4 px-md-5 py-4">

    <div class="text-center mb-4">
      <% if (product.image) { %>
        <img src="<%= product.image %>" alt="<%= product.name %>" class="img-fluid mb-3" style="max-height: 100px;">
      <% } %>
      <h4 class="fw-bold mb-1"><%= product.custom_name || product.name %></h4>
      <p class="text-success fs-5 mb-0">
        $<%= (parseFloat(product.custom_price || product.price || 0)).toFixed(2) %>
      </p>
      <div class="small text-muted mt-1">
        Balance: $<%= (user ? Number(user.balance || 0).toFixed(2) : '0.00') %>
      </div>
    </div>

    <input type="hidden" id="productId" value="<%= product.id %>">

    <% const finalMsg = typeof msg !== 'undefined' ? msg : ''; %>
    <% const safeError = typeof error !== 'undefined' ? error : ''; %>
    <% if (safeError || finalMsg) {
      let alertMsg = '';
      switch (safeError) {
        case 'balance':
          alertMsg = '❌ Insufficient balance to complete the order.';
          break;
        case 'notfound':
          alertMsg = '❌ Product not found or is disabled.';
          break;
        case 'failed':
        case 'order_failed':
          alertMsg = '❌ Failed to place your order. Please try again.';
          break;
        case 'missing_player':
          alertMsg = '❌ Player ID is required for this product.';
          break;
        case 'verify':
          alertMsg = `❌ ${decodeURIComponent(finalMsg || 'Player ID verification failed.')}`;
          break;
        case 'network':
          alertMsg = '❌ Network issue. Please try again shortly.';
          break;
        case 'server':
        default:
          alertMsg = '❌ An unexpected server error occurred.';
          break;
      }
    %>
      <div class="alert alert-danger small text-center my-2">
        <%= alertMsg %>
      </div>
    <% } %>

    <% 
      // افتراضات آمنة لو السيرفر ما مرّر canVerify/minCost
      const _canVerify = (typeof canVerify !== 'undefined') ? !!canVerify : true;
      const _minCostRaw = (typeof minCost !== 'undefined') ? Number(minCost) : Number(product.price || product.custom_price || 0);
      const _minCost = isNaN(_minCostRaw) ? 0 : _minCostRaw;
    %>

    <% if (product.requires_verification) { %>
      <div class="mb-3">
        <label class="form-label fw-semibold">Player ID</label>
        <div class="row g-2">
          <div class="col-12 col-md-9">
            <input type="text" class="form-control form-control-lg" id="playerIdInput" placeholder="Enter Player ID" required>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button 
              type="button" 
              id="btnVerify"
              class="btn btn-outline-primary btn-lg" 
              onclick="verifyPlayer()"
              <%= _canVerify ? '' : 'disabled' %>
              title="<%= _canVerify ? '' : ('Requires balance ≥ $' + Number(_minCost).toFixed(2)) %>">
              Verify
            </button>
          </div>
        </div>

        <% if (!_canVerify) { %>
          <div class="alert alert-warning mt-2 py-2">
            To verify player ID, your balance must be at least 
            <strong>$<%= Number(_minCost).toFixed(2) %></strong>.
          </div>
        <% } %>

        <div id="verifyResult" class="mt-2 small text-muted"></div>
      </div>
    <% } else if (product.requires_player_id) { %>
      <div class="mb-3">
        <label class="form-label fw-semibold">Player ID</label>
        <input type="text" class="form-control form-control-lg" id="playerIdInput" placeholder="Enter Player ID">
      </div>
    <% } %>

    <button class="btn btn-success w-100 btn-lg mt-3" onclick="submitOrder()">Buy Now</button>

    <div id="submitResult" class="mt-3 small text-center"></div>

    <div id="productData"
         data-product-id="<%= product.id %>"
         data-requires-verification="<%= product.requires_verification ? '1' : '0' %>"
         data-can-verify="<%= _canVerify ? '1' : '0' %>"
         data-min-cost="<%= Number(_minCost).toFixed(2) %>">
    </div>

  </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  async function verifyPlayer() {
    const meta = document.getElementById("productData")?.dataset || {};
    const canVerify = (meta.canVerify === '1');
    const minCost = Number(meta.minCost || 0);
    const playerId = document.getElementById("playerIdInput")?.value.trim();
    const productId = meta.productId;
    const resultBox = document.getElementById("verifyResult");

    if (!canVerify) {
      resultBox.innerHTML = "<span class='text-warning'>Balance too low to verify (requires ≥ $"+ (minCost.toFixed ? minCost.toFixed(2) : minCost) +").</span>";
      return;
    }

    if (!playerId) {
      resultBox.innerHTML = "<span class='text-danger'>Please enter a Player ID first.</span>";
      return;
    }

    resultBox.innerHTML = "⏳ Verifying...";

    try {
      const res = await fetch('/verify-player', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player_id: playerId, product_id: productId })
      });

      const data = await res.json();

      if (data.success) {
        resultBox.innerHTML = `<span class="text-success">✔️ Valid${data.player_name ? ': ' + data.player_name : ''}</span>`;
      } else {
        resultBox.innerHTML = `<span class="text-danger">❌ ${data.message || 'Invalid Player ID'}</span>`;
      }
    } catch (err) {
      resultBox.innerHTML = "<span class='text-danger'>❌ Failed to verify</span>";
      console.error("Verification Error:", err);
    }
  }

  async function submitOrder() {
    const productId = document.getElementById("productId").value;
    const resultBox = document.getElementById("submitResult");
    const playerIdInput = document.getElementById("playerIdInput");
    const player_id = playerIdInput ? playerIdInput.value.trim() : '';

    resultBox.innerHTML = "⏳ Processing order...";

    try {
      const res = await fetch('/buy-fixed-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, player_id })
      });

      const data = await res.json();

      if (data.success && data.redirectUrl) {
        window.location.href = data.redirectUrl;
      } else {
        resultBox.innerHTML = `<div class="alert alert-danger py-2">❌ ${data.message || 'Failed to place order'}</div>`;
      }
    } catch (err) {
      console.error("Order Error:", err);
      resultBox.innerHTML = `<div class="alert alert-danger py-2">❌ Something went wrong.</div>`;
    }
  }
</script>

</body>
</html>
