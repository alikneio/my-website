<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Orders - AK Cell</title>

  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    body { background:#f6f7fb; }
    .page-title { font-weight: 900; letter-spacing: .2px; }
    .card-soft{
      border:0; border-radius:16px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .stat-card{
      border:0; border-radius:16px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .stat-icon{
      width:42px;height:42px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(13,110,253,.12);
      color:#0d6efd;
      font-size:1.2rem;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
    }
    .badge-soft{
      border-radius:999px; padding:6px 10px;
      font-weight:800; font-size:.75rem;
      border:1px solid transparent;
      display:inline-flex; align-items:center; gap:6px;
    }
    .b-waiting{ background:rgba(245,158,11,.12); color:#92400e; border-color:rgba(245,158,11,.25); }
    .b-accepted{ background:rgba(34,197,94,.12); color:#166534; border-color:rgba(34,197,94,.25); }
    .b-rejected{ background:rgba(239,68,68,.12); color:#b91c1c; border-color:rgba(239,68,68,.25); }
    .table thead th{
      position: sticky; top: 0;
      background: #111827 !important;
      color:#fff; z-index: 2;
      white-space: nowrap;
    }
    .table td, .table th { vertical-align: middle; }
    .td-wrap{ max-width: 360px; white-space: normal; word-break: break-word; }
    .search-input, .filter-select, .btn-round { border-radius: 12px; }
    .small-muted{ color:#64748b; font-size:.85rem; }
    .btn-update{
      border-radius:12px;
      font-weight:800;
    }
    .row-form > * { min-width: 0; }
  </style>
</head>

<body>
<div class="d-flex">
  <%- include('partials/admin-sidebar') %>

  <div class="container-fluid p-4 p-lg-5">

    <% 
      const list = Array.isArray(orders) ? orders : [];
      const total = list.length;
      const waiting = list.filter(o => (o.status||'') === 'Waiting').length;
      const accepted = list.filter(o => (o.status||'') === 'Accepted').length;
      const rejected = list.filter(o => (o.status||'') === 'Rejected').length;

      function statusBadge(status){
        const s = String(status||'').toLowerCase();
        if (s === 'accepted') return { cls:'b-accepted', icon:'bi-check2-circle', label:'ACCEPTED' };
        if (s === 'rejected') return { cls:'b-rejected', icon:'bi-x-circle', label:'REJECTED' };
        return { cls:'b-waiting', icon:'bi-hourglass-split', label:'WAITING' };
      }
    %>

    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
      <div>
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-bag-check fs-2 text-primary"></i>
          <h1 class="page-title mb-0">Manage Orders</h1>
        </div>
        <div class="small-muted mt-1">Review, update statuses, and reply to customers.</div>
      </div>

      <div class="d-flex gap-2">
        <a href="/admin" class="btn btn-outline-secondary btn-round">
          <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
        <a href="/admin/orders" class="btn btn-primary btn-round">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </a>
      </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-3">
        <div class="stat-card p-3 bg-white">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon"><i class="bi bi-list-ul"></i></div>
            <div>
              <div class="small-muted">Total Orders</div>
              <div class="fs-4 fw-bold mono"><%= total %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="stat-card p-3 bg-white">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:rgba(245,158,11,.12); color:#f59e0b;">
              <i class="bi bi-hourglass-split"></i>
            </div>
            <div>
              <div class="small-muted">Waiting</div>
              <div class="fs-4 fw-bold mono"><%= waiting %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="stat-card p-3 bg-white">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:rgba(34,197,94,.12); color:#22c55e;">
              <i class="bi bi-check2-circle"></i>
            </div>
            <div>
              <div class="small-muted">Accepted</div>
              <div class="fs-4 fw-bold mono"><%= accepted %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="stat-card p-3 bg-white">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:rgba(239,68,68,.12); color:#ef4444;">
              <i class="bi bi-x-circle"></i>
            </div>
            <div>
              <div class="small-muted">Rejected</div>
              <div class="fs-4 fw-bold mono"><%= rejected %></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional Filters UI (حتى لو ما عندك backend إلها، ما بتكسر الصفحة) -->
    <div class="card card-soft mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end row-form">
          <div class="col-12 col-md-5">
            <label class="form-label fw-semibold">Quick Search (client-side)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="orderSearch" type="text" class="form-control search-input" placeholder="Search by user, product, details, id…">
            </div>
            <div class="small-muted mt-1">This search works instantly without server changes.</div>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Status</label>
            <select id="statusFilter" class="form-select filter-select">
              <option value="">All</option>
              <option value="Waiting">Waiting</option>
              <option value="Accepted">Accepted</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="clearFilters" class="btn btn-outline-secondary btn-round">
              <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
            </button>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button class="btn btn-dark btn-round" type="button" data-bs-toggle="collapse" data-bs-target="#tipsBox">
              <i class="bi bi-lightbulb me-1"></i> Tips
            </button>
          </div>

          <div class="col-12">
            <div class="collapse mt-2" id="tipsBox">
              <div class="alert alert-info mb-0">
                ✅ You can paste a full delivery link in <b>Admin Reply</b>.  
                ✅ Use <b>Accepted</b> when delivered, <b>Rejected</b> when not possible.  
                ✅ Search + status filter هنا شغالين <b>بدون backend</b>.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card card-soft">
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 70vh;">
          <table class="table table-hover mb-0" id="ordersTable">
            <thead>
              <tr>
                <th style="width:90px;">ID</th>
                <th style="width:180px;">User</th>
                <th style="width:260px;">Product</th>
                <th>Details</th>
                <th style="width:220px;">Date</th>
                <th style="width:170px;">Status</th>
                <th style="width:320px;">Admin Reply</th>
                <th style="width:120px;">Action</th>
              </tr>
            </thead>

            <tbody>
              <% if (orders && orders.length > 0) { %>
                <% orders.forEach(order => { 
                  const b = statusBadge(order.status);
                  const dateStr = order.purchaseDate ? new Date(order.purchaseDate).toLocaleString('en-US', { hour12: true }) : '-';
                  const reply = order.admin_reply || '';
                  const isLink = /^https?:\/\//i.test(reply.trim());
                %>

                  <tr data-status="<%= order.status %>">
                    <td class="mono fw-bold">#<%= order.id %></td>

                    <td>
                      <div class="fw-semibold"><%= order.username %></div>
                      <div class="small-muted">User ID: <span class="mono"><%= order.userId || '-' %></span></div>
                    </td>

                    <td class="td-wrap">
                      <div class="fw-semibold"><%= order.productName %></div>
                      <div class="small-muted">Price: <span class="mono">$<%= Number(order.price || 0).toFixed(2) %></span></div>
                    </td>

                    <td class="td-wrap">
                      <%= order.order_details || '-' %>
                    </td>

                    <td class="text-muted mono"><%= dateStr %></td>

                    <td>
                      <div class="mb-2">
                        <span class="badge-soft <%= b.cls %>">
                          <i class="bi <%= b.icon %>"></i> <%= b.label %>
                        </span>
                      </div>

                      <form action="/admin/order/update/<%= order.id %>" method="POST" class="d-flex gap-2">
                        <select name="status" class="form-select form-select-sm">
                          <option value="Waiting"  <%= order.status === 'Waiting' ? 'selected' : '' %>>Waiting</option>
                          <option value="Accepted" <%= order.status === 'Accepted' ? 'selected' : '' %>>Accepted</option>
                          <option value="Rejected" <%= order.status === 'Rejected' ? 'selected' : '' %>>Rejected</option>
                        </select>
                    </td>

                    <td>
                        <div class="input-group input-group-sm">
                          <input
                            type="text"
                            name="admin_reply"
                            class="form-control"
                            placeholder="e.g. https://delivery-link"
                            value="<%= reply %>"
                          />
                          <% if (isLink) { %>
                            <a class="btn btn-outline-secondary" target="_blank" href="<%= reply %>" title="Open link">
                              <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                          <% } %>
                        </div>
                        <div class="small-muted mt-1">You can paste link or short message.</div>
                    </td>

                    <td class="text-end">
                        <button type="submit" class="btn btn-primary btn-sm btn-update">
                          <i class="bi bi-save2 me-1"></i> Update
                        </button>
                      </form>
                    </td>
                  </tr>

                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="8" class="text-center p-5">
                    <div class="text-muted">
                      <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                      No orders found.
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>

          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Client-side search + status filter (بدون backend)
  const searchInput = document.getElementById('orderSearch');
  const statusFilter = document.getElementById('statusFilter');
  const clearBtn = document.getElementById('clearFilters');
  const table = document.getElementById('ordersTable');
  const rows = Array.from(table.querySelectorAll('tbody tr'));

  function applyFilters(){
    const q = (searchInput.value || '').toLowerCase().trim();
    const st = statusFilter.value;

    rows.forEach(r => {
      if (!r.querySelector) return;
      const status = r.getAttribute('data-status') || '';
      const text = r.innerText.toLowerCase();

      const matchQ = !q || text.includes(q);
      const matchS = !st || status === st;

      r.style.display = (matchQ && matchS) ? '' : 'none';
    });
  }

  searchInput?.addEventListener('input', applyFilters);
  statusFilter?.addEventListener('change', applyFilters);

  clearBtn?.addEventListener('click', () => {
    searchInput.value = '';
    statusFilter.value = '';
    applyFilters();
  });
</script>

</body>
</html>
