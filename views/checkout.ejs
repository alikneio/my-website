<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - <%= product.name %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    /* خلفية ناعمة */
    body {
      background: radial-gradient(1200px 600px at 20% 10%, rgba(25,135,84,.10), transparent 60%),
                  radial-gradient(1000px 500px at 90% 20%, rgba(13,110,253,.08), transparent 55%),
                  #f6f7fb;
    }

    .checkout-wrap { min-height: 72vh; }

    .checkout-card{
      border: 0;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,.08);
    }

    .checkout-head{
      background: linear-gradient(135deg, rgba(25,135,84,.12), rgba(13,110,253,.06));
      border-bottom: 1px solid rgba(0,0,0,.06);
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .checkout-title{
      display:flex;
      align-items:center;
      gap: 10px;
      margin:0;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .secure-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(25,135,84,.12);
      color: #146c43;
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }

    .product-img {
      max-height: 120px;
      object-fit: contain;
      border-radius: 14px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.06);
      padding: 10px;
    }

    .price-chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(25,135,84,.10);
      color: #146c43;
      font-weight: 900;
      font-size: 15px;
    }

    .summary-row{
      background: #fff;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      padding: 12px 14px;
    }

    .summary-label{
      font-size: 12px;
      color: rgba(0,0,0,.55);
      margin-bottom: 4px;
    }

    .summary-name{
      font-weight: 900;
      margin: 0;
      line-height: 1.2;
    }

    .form-control{
      border-radius: 12px;
      padding: 12px 14px;
    }

    .btn-buy{
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(25,135,84,.18);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn-buy:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 22px rgba(25,135,84,.22);
      filter: brightness(1.02);
    }
    .btn-buy:disabled{
      transform: none;
      box-shadow: none;
      opacity: .85;
    }

    /* نبضة خفيفة وقت المعالجة */
    .is-loading{
      position: relative;
    }
    .is-loading::after{
      content:'';
      position:absolute;
      inset: -2px;
      border-radius: 16px;
      border: 2px solid rgba(25,135,84,.18);
      animation: pulse 1.2s infinite ease-in-out;
      pointer-events:none;
    }
    @keyframes pulse{
      0%{ opacity:.2; transform: scale(.99); }
      50%{ opacity:.7; transform: scale(1.01); }
      100%{ opacity:.2; transform: scale(.99); }
    }

    .trust-row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 14px;
    }
    .trust-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 800;
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.70);
    }

    .muted-note{
      color: rgba(0,0,0,.55);
    }

    /* ========= BEST UI for Notes/Description ========= */
    .info-card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
      overflow: hidden;
    }

    .info-card .info-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(13,110,253,.09), rgba(25,135,84,.09));
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .info-title{
      display:flex;
      align-items:center;
      gap: 10px;
      margin: 0;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .info-chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(13,110,253,.10);
      color: rgba(13,110,253,1);
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }

    .info-body{
      padding: 12px 14px;
    }

    .desc-text{
      color: rgba(0,0,0,.72);
      line-height: 1.65;
      margin: 0;
      font-size: 14px;
      white-space: pre-wrap;
    }

    /* Read more */
    .clamp-3{
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .readmore-btn{
      border: 0;
      background: transparent;
      padding: 0;
      font-weight: 900;
      font-size: 13px;
    }

    /* Accordion polish */
    .accordion-button{
      border-radius: 14px !important;
      padding: 12px 14px;
      font-weight: 900;
    }
    .accordion-item{
      border: 0;
      background: transparent;
    }
    .accordion-button:not(.collapsed){
      background: rgba(25,135,84,.08);
      color: #146c43;
      box-shadow: none;
    }
    .accordion-body{
      padding: 12px 14px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.06);
      border-top: 0;
      border-radius: 0 0 16px 16px;
    }

    /* RTL helpers */
    .rtl { direction: rtl; text-align: right; }
    .ltr { direction: ltr; text-align: left; }

    /* tiny divider */
    .soft-divider{
      height: 1px;
      background: rgba(0,0,0,.06);
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>

  <div class="container my-5 checkout-wrap">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 mx-auto">

      <div class="card checkout-card">

        <!-- رأس الكارد -->
        <div class="checkout-head">
          <h5 class="checkout-title">
            <i class="bi bi-bag-check-fill"></i>
            Checkout
          </h5>

          <span class="secure-badge">
            <i class="bi bi-shield-lock-fill"></i>
            Secure Checkout
          </span>
        </div>

        <div class="card-body p-4">

          <!-- المنتج -->
          <div class="text-center mb-3">
            <img
              src="<%= product.image %>"
              alt="<%= product.name %>"
              class="img-fluid product-img"
              loading="lazy"
            >
          </div>

          <div class="summary-row mb-3 d-flex align-items-center justify-content-between gap-3">
            <div>
              <div class="summary-label">Product</div>
              <p class="summary-name mb-0"><%= product.name %></p>
            </div>

            <div class="text-end">
              <div class="summary-label">Total</div>
              <div class="price-chip">
                <i class="bi bi-cash-coin"></i>
                $<%= Number(product.price).toFixed(2) %>
              </div>

              <% if (product.original_price && Number(product.original_price) > Number(product.price)) { %>
                <div class="small text-muted mt-1">
                  <span style="text-decoration:line-through;">
                    $<%= Number(product.original_price).toFixed(2) %>
                  </span>
                  <% if (typeof effectiveDiscount !== 'undefined') { %>
                    <span class="ms-1">(-<%= Number(effectiveDiscount || 0) %>%)</span>
                  <% } %>
                </div>
              <% } %>
            </div>
          </div>

          <!-- ✅ Hybrid delivery banner (ONLY for stock-enabled products) -->
          <% if ((product.delivery_mode || 'manual') === 'stock') { %>
            <div class="alert <%= product.in_stock ? 'alert-success' : 'alert-warning' %> d-flex align-items-start gap-2 mb-3"
                 style="border-radius:14px;">
              <i class="bi <%= product.in_stock ? 'bi-lightning-charge-fill' : 'bi-hourglass-split' %> fs-5"></i>
              <div class="fw-bold" style="line-height:1.35;">
                <% if (product.in_stock) { %>
                  Instant delivery — your account will be delivered automatically after payment.
                  <div class="small fw-normal text-muted mt-1">You can view it inside Order Details.</div>
                <% } else { %>
                  Currently out of stock — your order will be placed as <span class="fw-bold">Pending</span> and processed manually by admin.
                  <div class="small fw-normal text-muted mt-1">Your payment is secured and the order will be fulfilled as soon as possible.</div>
                <% } %>
              </div>
            </div>
          <% } %>

          <!-- ✅ Error banner (from server query string /checkout/:id?error=...) -->
          <% if (error) { %>
            <div class="alert alert-danger d-flex align-items-center gap-2 mb-3" style="border-radius:14px;">
              <i class="bi bi-exclamation-triangle-fill"></i>
              <div class="fw-bold"><%= error %></div>
            </div>
          <% } %>

          <!-- ✅ BEST UI Notes/Description -->
          <%
            const hasDesc = !!(product.description && String(product.description).trim());
            const hasNotes = !!(product.notes && String(product.notes).trim());
            const detailsLang =
              /[\u0600-\u06FF]/.test((product.description || '') + ' ' + (product.notes || '')) ? 'rtl' : 'ltr';
          %>

          <% if (hasDesc || hasNotes) { %>
            <div class="info-card mb-4 <%= detailsLang %>">
              <div class="info-head">
                <h6 class="info-title">
                  <i class="bi bi-card-text"></i>
                  Details
                </h6>

                <span class="info-chip">
                  <i class="bi bi-info-circle-fill"></i>
                  Read Before Buying
                </span>
              </div>

              <div class="info-body">
                <div class="accordion" id="prodInfoAcc">

                  <% if (hasDesc) { %>
                    <div class="accordion-item mb-2">
                      <h2 class="accordion-header" id="headingDesc">
                        <button class="accordion-button" type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseDesc"
                          aria-expanded="true"
                          aria-controls="collapseDesc">
                          <i class="bi bi-journal-text me-2"></i>
                          Product Description
                        </button>
                      </h2>

                      <div id="collapseDesc" class="accordion-collapse collapse show"
                        aria-labelledby="headingDesc"
                        data-bs-parent="#prodInfoAcc">
                        <div class="accordion-body">
                          <p id="descText" class="desc-text clamp-3"><%= product.description %></p>
                          <button id="descToggle" type="button" class="readmore-btn mt-2 text-primary">
                            Read more <i class="bi bi-chevron-down"></i>
                          </button>

                          <% if (hasNotes) { %>
                            <div class="soft-divider"></div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                              <span class="badge text-bg-warning" style="border-radius:999px;">
                                <i class="bi bi-pencil-square me-1"></i> Notes
                              </span>
                              <span class="small text-muted">Extra info</span>
                            </div>
                            <p class="desc-text mb-0"><%= product.notes %></p>
                          <% } %>

                        </div>
                      </div>
                    </div>
                  <% } %>

                  <% if (!hasDesc && hasNotes) { %>
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="headingNotes">
                        <button class="accordion-button" type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseNotes"
                          aria-expanded="true"
                          aria-controls="collapseNotes">
                          <i class="bi bi-pencil-square me-2"></i>
                          Notes
                        </button>
                      </h2>

                      <div id="collapseNotes" class="accordion-collapse collapse show"
                        aria-labelledby="headingNotes"
                        data-bs-parent="#prodInfoAcc">
                        <div class="accordion-body">
                          <p class="desc-text mb-0"><%= product.notes %></p>
                        </div>
                      </div>
                    </div>
                  <% } %>

                </div>
              </div>
            </div>
          <% } %>

          <!-- ✅ نموذج الشراء -->
          <form
            id="sql-buy-form"
            method="POST"
            action="/buy"
            enctype="multipart/form-data"
            novalidate
          >
            <input type="hidden" name="productId" value="<%= product.id %>">
            <input type="hidden" name="idempotency_key" value="<%= idemKey %>">

            <% if (product.requires_player_id == 1) { %>
              <div class="mb-3">
                <label for="playerId" class="form-label fw-bold">
                  <i class="bi bi-person-vcard me-1"></i>
                  <%= product.player_id_label || 'Player ID' %>
                </label>

                <input
                  type="text"
                  class="form-control"
                  id="playerId"
                  name="playerId"
                  placeholder="Enter <%= product.player_id_label || 'Player ID' %>"
                  required
                  autocomplete="off"
                  inputmode="text"
                >

                <div class="invalid-feedback">
                  Please enter <%= product.player_id_label || 'Player ID' %>.
                </div>
              </div>
            <% } %>

            <button id="buyBtn" type="submit" class="btn btn-success w-100 btn-buy">
              <span class="btn-text">
                <i class="bi bi-lightning-charge-fill me-1"></i>
                Buy Now
              </span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>

            <div class="trust-row">
              <span class="trust-pill"><i class="bi bi-shield-check"></i> SSL Secured</span>
              <span class="trust-pill"><i class="bi bi-clock-history"></i> Fast Processing</span>
              <span class="trust-pill"><i class="bi bi-headset"></i> Support Available</span>
            </div>

            <p class="muted-note small mt-3 mb-0">
              By clicking “Buy Now”, your order will be processed securely.
            </p>
          </form>

        </div>
      </div>

    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const form = document.getElementById('sql-buy-form');
    const buyBtn = document.getElementById('buyBtn');
    const btnText = buyBtn.querySelector('.btn-text');
    const btnSpinner = buyBtn.querySelector('.spinner-border');

    let submitting = false;

    function setLoading(state) {
      submitting = state;
      buyBtn.disabled = state;

      if (state) {
        btnSpinner.classList.remove('d-none');
        buyBtn.classList.add('is-loading');
        btnText.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Processing...';
      } else {
        btnSpinner.classList.add('d-none');
        buyBtn.classList.remove('is-loading');
        btnText.innerHTML = '<i class="bi bi-lightning-charge-fill me-1"></i> Buy Now';
      }
    }

    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: 'خطأ',
        text: message || 'حدث خطأ أثناء تنفيذ العملية.'
      });
    }

    // ✅ Read more for description
    (function () {
      const descText = document.getElementById('descText');
      const descToggle = document.getElementById('descToggle');
      if (!descText || !descToggle) return;

      const isOverflowing = descText.scrollHeight > descText.clientHeight + 4;
      if (!isOverflowing) {
        descToggle.classList.add('d-none');
        descText.classList.remove('clamp-3');
        return;
      }

      let expanded = false;
      descToggle.addEventListener('click', () => {
        expanded = !expanded;
        descText.classList.toggle('clamp-3', !expanded);
        descToggle.innerHTML = expanded
          ? 'Show less <i class="bi bi-chevron-up"></i>'
          : 'Read more <i class="bi bi-chevron-down"></i>';
      });
    })();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return;

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      setLoading(true);

      try {
        const formData = new FormData(form);

        const res = await fetch(form.action || '/buy', {
          method: 'POST',
          body: formData,
          headers: { 'Accept': 'application/json' },
          redirect: 'manual'
        });

        if (res.status >= 300 && res.status < 400) {
          setLoading(false);
          showError('السيرفر رجّع Redirect بدل JSON. لازم /buy يرجّع JSON فقط.');
          return;
        }

        const contentType = (res.headers.get('content-type') || '').toLowerCase();

        if (!contentType.includes('application/json')) {
          const text = await res.text().catch(() => '');
          console.error('Non-JSON response:', text);
          setLoading(false);
          showError('رد غير متوقع من السيرفر (ليس JSON). تأكد من روت /buy.');
          return;
        }

        const data = await res.json();

        if (!res.ok || !data?.success) {
          setLoading(false);
          showError(data?.message || 'تعذّر إتمام العملية. تأكد من الرصيد أو البيانات.');
          return;
        }

        window.location.href = data.redirectUrl || '/processing';

      } catch (err) {
        console.error(err);
        setLoading(false);
        showError('تعذر تنفيذ الطلب، تأكد من الاتصال بالإنترنت.');
      }
    });
  </script>

</body>
</html>
