<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product-card {
      cursor: pointer;
      opacity: 0;
      transform: scale(0.95) translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      position: relative;
    }
    .product-card.visible {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* تعطيل الكارد إذا Out of Stock */
    .product-card.is-oos {
      cursor: not-allowed;
      opacity: .65;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <h2 class="mb-4">Available Products</h2>

  <div class="row">
    <% products.forEach(product => { %>
      <%
        const isOOS = Number(product.is_out_of_stock) > 0;
      %>

      <div class="col-md-4 mb-3">
        <div class="card product-card <%= isOOS ? 'is-oos' : '' %>"
             data-id="<%= product.id %>"
             data-source="<%= product.source || 'api' %>"
             data-oos="<%= isOOS ? 1 : 0 %>">

          <img src="<%= product.image || '/images/webp/default-product.webp' %>"
               class="card-img-top"
               style="height: 150px; object-fit: cover;">

          <div class="card-body text-center">
            <h5><%= product.name %></h5>

            <% if (product.variable_quantity) { %>
              <span class="badge bg-warning text-dark">Quantity</span>
            <% } else { %>
              <span class="badge bg-success">Fixed</span>
            <% } %>

            <% if (isOOS) { %>
              <div class="mt-2">
                <span class="badge bg-danger">OUT OF STOCK</span>
              </div>
            <% } %>
          </div>

        </div>
      </div>
    <% }) %>
  </div>

  <div id="checkoutSection" class="mt-5"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => card.classList.remove('visible'));
    setTimeout(() => {
      cards.forEach((card, i) => {
        setTimeout(() => card.classList.add('visible'), i * 150);
      });
    }, 300);

    cards.forEach(card => {
      card.addEventListener('click', function () {
        if (this.dataset.oos === "1") return; // ⛔ Out of stock

        const productId = this.dataset.id;
        const source = this.dataset.source || 'api';

        if (source === 'sql') loadSqlCheckout(productId);
        else loadApiCheckout(productId);
      });
    });
  });

  async function loadApiCheckout(productId) {
    const container = document.getElementById('checkoutSection');
    container.innerHTML = "<div class='text-center py-4'>⏳ Loading API checkout...</div>";

    try {
      const res = await fetch(`/load-checkout/${productId}`);
      const html = await res.text();
      container.innerHTML = `<div class="fade-in">${html}</div>`;
    } catch (err) {
      container.innerHTML = "<div class='alert alert-danger'>❌ Failed to load API checkout.</div>";
    }
  }

  async function loadSqlCheckout(productId) {
    const container = document.getElementById('checkoutSection');
    container.innerHTML = "<div class='text-center py-4'>⏳ Loading checkout...</div>";

    try {
      const res = await fetch(`/load-sql-checkout/${productId}`);
      const html = await res.text();
      container.innerHTML = `<div class="fade-in">${html}</div>`;
    } catch (err) {
      container.innerHTML = "<div class='alert alert-danger'>❌ Failed to load checkout.</div>";
    }
  }
</script>

</body>
</html>
