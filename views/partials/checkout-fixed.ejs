<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - <%= product.name %></title>

  <!-- Styles -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    /* تحسين عرض الموبايل */
    @media (max-width: 576px) {
      .card { width: 100% !important; margin-bottom: 2rem !important; }
      .card-body { padding: 1.5rem !important; }
      .card-body h4 { font-size: 1.2rem !important; }
      .card-body p { font-size: 1rem !important; }
      .input-group { flex-direction: column !important; align-items: stretch !important; }
      .input-group input { width: 100% !important; margin-bottom: 0.75rem !important; }
      .input-group button { width: 100% !important; }
      #submitResult { font-size: 0.9rem !important; }
      .container.py-5 { padding-bottom: 8rem !important; padding-top: 1rem !important; }
    }
  </style>
</head>
<body class="bg-light">

  <%- include('partials/header') %>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 mx-auto px-2">

        <!-- Product Card -->
        <div class="card shadow-lg">
          <div class="card-body text-center">

            <% if (product.image) { %>
              <img src="<%= product.image %>" alt="<%= product.name %>" class="img-fluid mb-3" style="max-height: 100px;">
            <% } %>

            <h4 class="fw-bold"><%= product.custom_name || product.name %></h4>
            <p class="fs-5 text-success mb-1">
              $<%= Number(product.custom_price || product.price || 0).toFixed(2) %>
            </p>

            <!-- hidden data -->
            <input type="hidden" id="productId" value="<%= product.id %>">
            <input type="hidden" id="idemKey" value="<%= idemKey %>">

            <% if (product.requires_player_id) { %>
              <!-- Player ID -->
              <div class="mb-3 text-start">
                <label class="form-label">Player ID</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="playerIdInput" placeholder="Enter Player ID" required>
                  <button type="button" class="btn btn-outline-primary" id="verifyBtn" onclick="verifyPlayer()">Verify</button>
                </div>
                <div id="verifyResult" class="mt-2 small text-muted"></div>
              </div>
            <% } %>

            <!-- Submit -->
            <button class="btn btn-success w-100" id="buyBtn" onclick="submitOrder()">✅ Complete Purchase</button>

            <!-- Result -->
            <div id="submitResult" class="mt-3 small text-center"></div>

          </div>
        </div>

        <div id="productData" data-product-id="<%= product.id %>"></div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let submitting = false; // حارس برمجي لمنع الدبل-طلب

    async function verifyPlayer() {
      const playerIdEl = document.getElementById("playerIdInput");
      const resultBox = document.getElementById("verifyResult");
      const productId = document.getElementById("productData").dataset.productId;

      const playerId = (playerIdEl?.value || '').trim();
      if (!playerId) {
        resultBox.innerHTML = "<span class='text-danger'>Please enter a Player ID first.</span>";
        return;
      }

      resultBox.innerHTML = "⏳ Verifying...";
      try {
        const res = await fetch('/verify-player', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ player_id: playerId, product_id: productId })
        });
        const data = await res.json();
        if (data.success) {
          resultBox.innerHTML = `<span class="text-success">✔️ Valid${data.player_name ? ': ' + data.player_name : ''}</span>`;
        } else {
          resultBox.innerHTML = `<span class="text-danger">❌ ${data.message || 'Invalid Player ID'}</span>`;
        }
      } catch (err) {
        resultBox.innerHTML = "<span class='text-danger'>❌ Failed to verify</span>";
        console.error("Verification Error:", err);
      }
    }

    async function submitOrder() {
      if (submitting) return; // منع التكرار
      submitting = true;

      const buyBtn = document.getElementById('buyBtn');
      const resultBox = document.getElementById("submitResult");

      const productId = document.getElementById("productId").value;
      const idempotency_key = document.getElementById("idemKey").value;

      const playerIdEl = document.getElementById("playerIdInput");
      const requiresPlayer = !!playerIdEl;
      const player_id = (playerIdEl?.value || '').trim();

      // تحقق لاعب إن مطلوب
      if (requiresPlayer && !player_id) {
        resultBox.innerHTML = `<div class="alert alert-danger py-2">❌ Please enter Player ID.</div>`;
        submitting = false;
        return;
      }

      buyBtn.disabled = true;
      resultBox.innerHTML = "⏳ Processing order...";

      try {
        const res = await fetch('/buy-fixed-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId,
            player_id: requiresPlayer ? player_id : undefined,
            idempotency_key // مهم جدًا لمنع التكرار
          })
        });

        // إذا الراوت عندك بيرجّع redirect بدل JSON:
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }

        const data = await res.json();
        if (data.success) {
          resultBox.innerHTML = `<div class="alert alert-success py-2">✅ Order placed successfully!</div>`;
          // اختياري: redirect بعد لحظات
          setTimeout(() => { window.location.href = '/processing'; }, 600);
        } else {
          resultBox.innerHTML = `<div class="alert alert-danger py-2">❌ ${data.message || 'Failed to place order'}</div>`;
          buyBtn.disabled = false;
          submitting = false;
        }
      } catch (err) {
        console.error("Order Error:", err);
        resultBox.innerHTML = `<div class="alert alert-danger py-2">❌ Something went wrong.</div>`;
        buyBtn.disabled = false;
        submitting = false;
      }
    }

    // كمان منع دبل-كليك بالكيبورد (Enter)
    document.addEventListener('keydown', (e) => {
      if ((e.key === 'Enter' || e.keyCode === 13) && submitting) {
        e.preventDefault();
      }
    });
  </script>

</body>
</html>
