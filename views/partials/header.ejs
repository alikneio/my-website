<!-- زر المنيو نفسه بدون تغيير -->
<a class="btn btn-dark m-3" data-bs-toggle="offcanvas" href="#offcanvasMenu" role="button" aria-controls="offcanvasMenu">
  <i class="bi bi-list"></i> Menu
</a>

<style>
  .ak-menu-offcanvas {
    background: radial-gradient(circle at top left, #111827, #020617);
    color: #f9fafb;
  }
  .ak-user-card {
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.45);
    padding: 14px;
    margin-bottom: 16px;
  }
  .ak-user-meta {
    font-size: 0.82rem;
    opacity: 0.9;
  }
  .ak-pill {
    border-radius: 999px;
    padding: 3px 10px;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  .ak-pill-level {
    background: #facc15;
    color: #1f2937;
    font-weight: 600;
  }
  .ak-pill-discount {
    background: #22c55e;
    color: #022c22;
    font-weight: 600;
  }
  .ak-menu-link {
    border-radius: 10px;
    padding: 7px 10px;
    margin-bottom: 6px;
    font-size: 0.95rem;
    color: #e5e7eb !important;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ak-menu-link i {
    width: 18px;
    font-size: 1.1rem;
  }
  .ak-menu-link:hover {
    background: rgba(255,255,255,0.08);
  }
  .ak-divider {
    border-top: 1px solid rgba(148, 163, 184, 0.4);
    margin: 12px 0;
  }
</style>

<div class="offcanvas offcanvas-start ak-menu-offcanvas" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
  
  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title" id="offcanvasMenuLabel">AK Cell Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">

    <!-- Notifications -->
    <a href="/notifications" class="btn btn-outline-light btn-sm position-relative mb-3" id="notifLink">
      <i class="bi bi-bell" id="notifIcon"></i>
      <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="display: none;">
        0
      </span>
    </a>

    <script>
      async function fetchNotificationsCount() {
        try {
          const res = await fetch('/notifications/count');
          const data = await res.json();
          const count = data.count || 0;

          const badge = document.getElementById('notifBadge');
          const icon = document.getElementById('notifIcon');

          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
            icon.classList.add('text-warning');
          } else {
            badge.style.display = 'none';
            icon.classList.remove('text-warning');
          }
        } catch (err) {
          console.error("❌ Failed to fetch notifications:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", fetchNotificationsCount);
      setInterval(fetchNotificationsCount, 30000);
    </script>

    <% if (user) { %>
      <% 
        const userBalance    = Number(user.balance || 0);
        const userLevel      = user.level || 1;
        const userDiscount   = Number(user.discount_percent || 0);
        const userTotalSpent = Number(user.total_spent || 0);
      %>

      <!-- كرت المستخدم / الليفل / الخصم -->
      <div class="ak-user-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">Welcome, <%= user.username %></h5>
            <div class="ak-user-meta">
              Balance:
              <span class="text-success fw-bold">
                $<%= userBalance.toFixed(2) %>
              </span>
            </div>
          </div>
          <div class="text-end">
            <span class="small text-muted d-block">Level</span>
            <span class="badge bg-light text-dark"><%= userLevel %></span>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <span class="ak-pill ak-pill-level">
            <i class="bi bi-arrow-up-circle"></i>
            Level <%= userLevel %>
          </span>
          <span class="ak-pill ak-pill-discount">
            <i class="bi bi-percent"></i>
            <%= userDiscount.toFixed(0) %>% Discount
          </span>
        </div>

        <div class="text-muted small mt-2">
          Total spent:
          $<%= userTotalSpent.toFixed(2) %>
        </div>
      </div>

      <div class="ak-divider"></div>

      <!-- روابط القائمة -->
      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="ak-menu-link" href="/profile">
            <i class="bi bi-person-fill"></i> My Profile
          </a>
        </li>

        <li class="nav-item">
          <a href="/add-balance/whish" class="ak-menu-link">
            <i class="bi bi-credit-card-2-front"></i> Add Balance
          </a>
        </li>

        <li class="nav-item">
          <a class="ak-menu-link" href="/">
            <i class="bi bi-house-door-fill"></i> Home
          </a>
        </li>

        <li class="nav-item">
          <a class="ak-menu-link" href="/my-orders">
            <i class="bi bi-bag-fill"></i> My Orders
          </a>
        </li>

        <li class="nav-item">
          <a href="/transactions" class="ak-menu-link">
            <i class="bi bi-cash-coin"></i> Transactions
          </a>
        </li>
      </ul>

      <div class="ak-divider"></div>

      <% if (user.role === 'admin') { %>
        <a class="btn btn-warning w-100 mb-3" href="/admin">
          <i class="bi bi-person-circle me-2"></i> Admin Panel
        </a>
      <% } %>

      <a class="btn btn-outline-danger w-100 mt-auto" href="/logout">
        <i class="bi bi-box-arrow-right me-2"></i>Logout
      </a>

    <% } else { %>
      <div class="mb-3">
        <p class="mb-1">Welcome to AK Cell</p>
        <small class="text-muted">Login to see your level & discounts</small>
      </div>
      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="ak-menu-link" href="/">
            <i class="bi bi-house-door-fill"></i> Home
          </a>
        </li>
        <li class="nav-item">
          <a class="ak-menu-link" href="/login">
            <i class="bi bi-box-arrow-in-right"></i> Login
          </a>
        </li>
        <li class="nav-item">
          <a class="ak-menu-link" href="/register">
            <i class="bi bi-person-plus-fill"></i> Register
          </a>
        </li>
      </ul>
    <% } %>
    
  </div>
</div>
