<!-- ======= AK CELL HEADER & SIDE MENU ======= -->

<style>
  .ak-navbar {
    background: linear-gradient(90deg, #020617, #0f172a, #1e293b);
    box-shadow: 0 4px 18px rgba(15,23,42,0.75);
  }
  .ak-navbar-brand {
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    font-size: 1rem;
    line-height: 1.1;
  }
  .ak-navbar-brand span {
    color: #38bdf8;
  }
  .ak-navbar-sub {
    font-size: 0.72rem;
    opacity: 0.75;
  }

  /* زر القائمة الجانبي (تحت الهيدر) */
  .ak-floating-menu-wrapper {
    padding: 0.75rem 1rem 0;
  }
  .ak-floating-menu-btn {
    background: #0ea5e9;
    border: none;
    padding: 0.45rem 0.95rem;
    border-radius: 999px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    color: #fff;
    cursor: pointer;
    transition: 0.18s ease;
    box-shadow: 0 4px 12px rgba(56,189,248,0.4);
  }
  .ak-floating-menu-btn i {
    font-size: 1.1rem;
  }
  .ak-floating-menu-btn:hover {
    background: #38bdf8;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(56,189,248,0.55);
  }

  /* OFFCANVAS MENU STYLES */
  .ak-menu-offcanvas {
    background: radial-gradient(circle at top left, #111827, #020617);
    color: #f9fafb;
  }
  .ak-menu-offcanvas .offcanvas-header {
    background: linear-gradient(90deg, #0f172a, #1e293b);
  }
  .ak-menu-offcanvas .offcanvas-title {
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  .ak-user-card {
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.4);
    padding: 12px 14px;
    margin-bottom: 14px;
  }
  .ak-user-card h6 {
    font-size: 0.95rem;
    margin-bottom: 2px;
  }
  .ak-user-meta {
    font-size: 0.8rem;
    opacity: 0.85;
  }
  .ak-user-stats {
    background: rgba(15, 23, 42, 0.9);
    border-radius: 12px;
    padding: 6px 10px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  .ak-pill {
    border-radius: 999px;
    padding: 3px 10px;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .ak-pill-level {
    background: #facc15;
    color: #1f2937;
    font-weight: 600;
  }
  .ak-pill-discount {
    background: #22c55e;
    color: #022c22;
    font-weight: 600;
  }

  .ak-divider {
    border-top: 1px solid rgba(148, 163, 184, 0.35);
    margin: 14px 0;
  }

  .ak-menu-link {
    border-radius: 10px;
    padding: 7px 10px;
    margin-bottom: 4px;
    font-size: 0.92rem;
  }
  .ak-menu-link i {
    width: 18px;
  }
  .ak-menu-link:hover {
    background: rgba(15, 23, 42, 0.85);
    color: #e5e7eb;
  }

  .ak-admin-btn {
    border-radius: 999px;
    font-weight: 600;
  }
</style>

<!-- Top Navbar -->
<nav class="navbar navbar-dark ak-navbar">
  <div class="container-fluid">
    <a class="navbar-brand d-flex flex-column ak-navbar-brand" href="/">
      AK <span>CELL</span>
      <small class="ak-navbar-sub">CARDS • SERVICES</small>
    </a>

    <% if (user) { %>
      <div class="text-end text-white-50">
        <div style="font-size: 0.8rem;">
          Hello, <span class="fw-semibold"><%= user.username %></span>
        </div>
        <div style="font-size: 0.78rem;">
          Balance:
          <span class="text-success fw-semibold">
            $<%= Number(user.balance || 0).toFixed(2) %>
          </span>
        </div>
      </div>
    <% } %>
  </div>
</nav>

<!-- زر القائمة الجانبي تحت الهيدر -->
<div class="ak-floating-menu-wrapper">
  <button class="ak-floating-menu-btn"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasMenu"
          aria-controls="offcanvasMenu">
    <i class="bi bi-list"></i>
    <span>Menu</span>
  </button>
</div>

<!-- Offcanvas MENU -->
<div class="offcanvas offcanvas-start ak-menu-offcanvas" tabindex="-1"
     id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
  
  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title d-flex align-items-center" id="offcanvasMenuLabel">
      <i class="bi bi-controller me-2"></i> AK Cell Menu
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">

    <!-- Notifications -->
    <div class="d-flex justify-content-end mb-2">
      <a href="/notifications" class="btn btn-outline-light btn-sm position-relative" id="notifLink">
        <i class="bi bi-bell" id="notifIcon"></i>
        <span id="notifBadge"
              class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill"
              style="display: none;">
          0
        </span>
      </a>
    </div>

    <script>
      async function fetchNotificationsCount() {
        try {
          const res = await fetch('/notifications/count');
          const data = await res.json();
          const count = data.count || 0;

          const badge = document.getElementById('notifBadge');
          const icon = document.getElementById('notifIcon');

          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
            icon.classList.add('text-warning');
          } else {
            badge.style.display = 'none';
            icon.classList.remove('text-warning');
          }
        } catch (err) {
          console.error("❌ Failed to fetch notifications:", err);
        }
      }
      document.addEventListener("DOMContentLoaded", fetchNotificationsCount);
      setInterval(fetchNotificationsCount, 30000);
    </script>

    <% if (user) { %>
      <% 
        const userBalance = Number(user.balance || 0);
        const userLevel = user.level || 1;
        const userDiscount = Number(user.discount_percent || 0);
        const userTotalSpent = Number(user.total_spent || 0);
      %>

      <!-- USER CARD -->
      <div class="ak-user-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">Welcome, <%= user.username %></h6>
            <div class="ak-user-meta">
              Balance:
              <span class="text-success fw-semibold">
                $<%= userBalance.toFixed(2) %>
              </span>
            </div>
          </div>
          <div class="text-end">
            <span class="small text-muted d-block">Level</span>
            <span class="badge bg-light text-dark">
              <%= userLevel %>
            </span>
          </div>
        </div>

        <div class="mt-2 d-flex flex-wrap gap-2">
          <span class="ak-pill ak-pill-level">
            <i class="bi bi-arrow-up-circle"></i>
            Level <%= userLevel %>
          </span>
          <span class="ak-pill ak-pill-discount">
            <i class="bi bi-percent"></i>
            Discount <%= userDiscount.toFixed(0) %>%
          </span>
        </div>

        <div class="ak-user-stats mt-2">
          <div class="d-flex justify-content-between">
            <span class="text-muted">Total spent</span>
            <span class="fw-semibold">$<%= userTotalSpent.toFixed(2) %></span>
          </div>
        </div>
      </div>

      <div class="ak-divider"></div>

      <!-- LINKS -->
      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/profile">
            <i class="bi bi-person-fill me-2"></i> My Profile
          </a>
        </li>

        <li class="nav-item">
          <a href="/add-balance/whish" class="nav-link text-white ak-menu-link d-flex align-items-center">
            <i class="bi bi-credit-card-2-front me-2"></i>
            Add Balance
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/">
            <i class="bi bi-house-door-fill me-2"></i> Home
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/my-orders">
            <i class="bi bi-bag-fill me-2"></i> My Orders
          </a>
        </li>

        <li class="nav-item">
          <a href="/transactions" class="nav-link text-white ak-menu-link">
            <i class="bi bi-cash-coin me-2"></i> Transactions
          </a>
        </li>
      </ul>

      <div class="ak-divider"></div>

      <% if (user.role === 'admin') { %>
        <a class="btn btn-warning ak-admin-btn w-100 mb-3" href="/admin">
          <i class="bi bi-person-circle me-2"></i> Admin Panel
        </a>
      <% } %>

      <a class="btn btn-outline-danger w-100 mt-auto" href="/logout">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </a>

    <% } else { %>

      <div class="text-center mb-3">
        <p class="mb-1">Welcome to AK Cell</p>
        <small class="text-muted">Login to see your level & discounts</small>
      </div>

      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/">
            <i class="bi bi-house-door-fill me-2"></i> Home
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/login">
            <i class="bi bi-box-arrow-in-right me-2"></i> Login
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white ak-menu-link" href="/register">
            <i class="bi bi-person-plus-fill me-2"></i> Register
          </a>
        </li>
      </ul>

    <% } %>
    
  </div>
</div>
