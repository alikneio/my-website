<!-- زر المنيو -->
<button class="btn btn-dark m-3" type="button"
        data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu"
        aria-controls="offcanvasMenu">
  <i class="bi bi-list"></i> Menu
</button>

<style>
  .ak-menu-offcanvas {
    background: radial-gradient(circle at top left, #111827, #020617);
    color: #f9fafb;
  }
  .ak-user-card {
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.45);
    padding: 14px;
    margin-bottom: 16px;
  }
  .ak-user-meta {
    font-size: 0.82rem;
    opacity: 0.9;
  }
  .ak-pill {
    border-radius: 999px;
    padding: 3px 10px;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .ak-pill-level {
    background: #facc15;
    color: #1f2937;
    font-weight: 700;
  }
  .ak-pill-discount {
    background: #22c55e;
    color: #022c22;
    font-weight: 800;
  }
  .ak-menu-link {
    border-radius: 10px;
    padding: 7px 10px;
    margin-bottom: 6px;
    font-size: 0.95rem;
    color: #e5e7eb !important;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }
  .ak-menu-link i {
    width: 18px;
    font-size: 1.1rem;
  }
  .ak-menu-link:hover {
    background: rgba(255,255,255,0.08);
  }
  .ak-divider {
    border-top: 1px solid rgba(148, 163, 184, 0.4);
    margin: 12px 0;
  }
  .ak-mini-tag {
    font-size: .7rem;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(2,44,34,.25);
    background: rgba(255,255,255,.35);
    color: #052e16;
  }
</style>

<%
  // suffix لمنع تكرار IDs لو الpartial تكرر
  const _menuUid = (typeof menuUid !== 'undefined' && menuUid) ? String(menuUid) : String(Date.now());
%>

<div class="offcanvas offcanvas-start ak-menu-offcanvas"
     tabindex="-1"
     id="offcanvasMenu"
     aria-labelledby="offcanvasMenuLabel-<%= _menuUid %>">

  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title" id="offcanvasMenuLabel-<%= _menuUid %>">AK Cell Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">

    <!-- Notifications -->
    <a href="/notifications"
       class="btn btn-outline-light btn-sm position-relative mb-3"
       id="notifLink-<%= _menuUid %>">
      <i class="bi bi-bell" id="notifIcon-<%= _menuUid %>"></i>
      <span id="notifBadge-<%= _menuUid %>"
            class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill"
            style="display:none;">
        0
      </span>
    </a>

    <% if (user) { %>
      <%
        const userBalance    = Number(user.balance || 0);
        const userLevel      = Number(user.level || 1);
        const userDiscount   = Number(user.discount_percent || 0);
        const userTotalSpent = Number(user.total_spent || 0);

        // ✅ Auto discount by level (حسب النظام الجديد)
        const levelDiscountMap = { 1: 0, 2: 2, 3: 4, 4: 6, 5: 10 };
        const autoDiscount = (levelDiscountMap[userLevel] ?? 0);

        // ✅ Effective discount: manual wins, otherwise auto
        const effectiveDiscount = (userDiscount > 0) ? userDiscount : autoDiscount;
        const discountMode = (userDiscount > 0) ? 'Manual' : 'Auto';
      %>

      <!-- User card -->
      <div class="ak-user-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">Welcome, <%= user.username %></h5>
            <div class="ak-user-meta">
              Balance:
              <span class="text-success fw-bold">
                $<%= userBalance.toFixed(2) %>
              </span>
            </div>
          </div>
          <div class="text-end">
            <span class="small text-muted d-block">Level</span>
            <span class="badge bg-light text-dark"><%= userLevel %></span>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <span class="ak-pill ak-pill-level">
            <i class="bi bi-arrow-up-circle"></i>
            Level <%= userLevel %>
          </span>

          <span class="ak-pill ak-pill-discount">
            <i class="bi bi-percent"></i>
            <%= Number(effectiveDiscount).toFixed(0) %>% Discount
            <span class="ak-mini-tag"><%= discountMode %></span>
          </span>
        </div>

        <div class="text-muted small mt-2">
          Total spent: $<%= userTotalSpent.toFixed(2) %>
        </div>
      </div>

      <div class="ak-divider"></div>

      <!-- Links -->
      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="ak-menu-link" href="/profile">
            <i class="bi bi-person-fill"></i> My Profile
          </a>
        </li>

        <li class="nav-item">
  <a class="ak-menu-link" href="/my-balance">
    <i class="bi bi-wallet2"></i> My Balance
    <% if ((pendingBalanceCount || 0) > 0) { %>
      <span class="badge bg-warning text-dark ms-auto"><%= pendingBalanceCount %></span>
    <% } %>
  </a>
</li>


        <li class="nav-item">
          <a href="/add-balance/whish" class="ak-menu-link">
            <i class="bi bi-credit-card-2-front"></i> Add Balance
          </a>
        </li>

        <li class="nav-item">
          <a class="ak-menu-link" href="/">
            <i class="bi bi-house-door-fill"></i> Home
          </a>
        </li>

        <li class="nav-item">
          <a class="ak-menu-link" href="/my-orders">
            <i class="bi bi-bag-fill"></i> My Orders
          </a>
        </li>

        <li class="nav-item">
          <a href="/transactions" class="ak-menu-link">
            <i class="bi bi-cash-coin"></i> Transactions
          </a>
        </li>
      </ul>

      <div class="ak-divider"></div>

      <% if (user.role === 'admin') { %>
        <a class="btn btn-warning w-100 mb-3" href="/admin">
          <i class="bi bi-person-circle me-2"></i> Admin Panel
        </a>
      <% } %>

      <a class="btn btn-outline-danger w-100 mt-auto" href="/logout">
        <i class="bi bi-box-arrow-right me-2"></i>Logout
      </a>

    <% } else { %>

      <div class="mb-3">
        <p class="mb-1">Welcome to AK Cell</p>
        <small class="text-muted">Login to see your level & discounts</small>
      </div>

      <ul class="navbar-nav flex-grow-1">
        <li class="nav-item">
          <a class="ak-menu-link" href="/">
            <i class="bi bi-house-door-fill"></i> Home
          </a>
        </li>
        <li class="nav-item">
          <a class="ak-menu-link" href="/login">
            <i class="bi bi-box-arrow-in-right"></i> Login
          </a>
        </li>
        <li class="nav-item">
          <a class="ak-menu-link" href="/register">
            <i class="bi bi-person-plus-fill"></i> Register
          </a>
        </li>
      </ul>

    <% } %>

  </div>
</div>

<script>
  (function(){
    const uid = "<%= _menuUid %>";
    const badge = document.getElementById("notifBadge-" + uid);
    const icon  = document.getElementById("notifIcon-" + uid);

    if (!badge || !icon) return;

    let timer = null;

    async function fetchNotificationsCount() {
      try {
        const res = await fetch('/notifications/count', { headers: { 'Accept': 'application/json' } });

        if (!res.ok) {
          badge.style.display = 'none';
          icon.classList.remove('text-warning');
          return;
        }

        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) return;

        const data = await res.json();
        const count = Number(data?.count || 0);

        if (count > 0) {
          badge.textContent = count > 99 ? "99+" : String(count);
          badge.style.display = 'inline-block';
          icon.classList.add('text-warning');
        } else {
          badge.style.display = 'none';
          icon.classList.remove('text-warning');
        }
      } catch (err) {
        console.error("❌ Failed to fetch notifications:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchNotificationsCount();
      timer = setInterval(fetchNotificationsCount, 30000);
    });

    window.addEventListener("beforeunload", () => {
      if (timer) clearInterval(timer);
    });
  })();
</script>
